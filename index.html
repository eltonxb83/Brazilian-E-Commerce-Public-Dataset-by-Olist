<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Brazilian E-Commerce ‚Äì Interactive Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google API JS (gapi) -->
  <script src="https://apis.google.com/js/api.js"></script>

  <!-- Plotly for interactive charts -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    :root {
      --bg: #f7f8fb;
      --card-bg: #ffffff;
      --accent: #0066cc;
      --accent-soft: #e6f0ff;
      --text-main: #222;
      --text-sub: #555;
      --border-soft: #dde3f0;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    header h1 {
      font-size: 1.6rem;
      margin: 0;
    }

    header p {
      margin: 0;
      color: var(--text-sub);
      font-size: 0.9rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent-soft);
      color: var(--accent);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 0.9rem;
      background: var(--accent);
      color: #fff;
    }

    button.secondary {
      background: #fff;
      color: var(--accent);
      border: 1px solid var(--accent);
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 12px 12px 16px;
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border-soft);
      min-height: 180px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .card-sub {
      font-size: 0.8rem;
      color: var(--text-sub);
    }

    .status {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .status span {
      font-weight: 600;
    }

    .chart-container {
      width: 100%;
      height: 360px;
    }

    .footer {
      margin-top: 14px;
      font-size: 0.75rem;
      color: var(--text-sub);
      text-align: right;
    }

    code {
      font-size: 0.8rem;
      background: #f0f3fa;
      padding: 2px 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div>
      <h1>Brazilian E-Commerce Dashboard</h1>
      <p>Powered by BigQuery + dbt star schema (fact_db_order_items + dim_db_* tables)</p>
      <div class="pill">
        <span>‚óè</span> Live from BigQuery
      </div>
    </div>

    <div class="controls">
      <button id="signin-btn">Sign in with Google</button>
      <button id="refresh-btn" class="secondary" disabled>Refresh charts</button>
    </div>
  </header>

  <div class="status" id="status">
    Status: <span>Not signed in</span>
  </div>

  <main class="grid">
    <!-- Left: Revenue over time -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Revenue over Time</div>
          <div class="card-sub">Daily gross order item value (BRL)</div>
        </div>
      </div>
      <div id="chart_revenue_time" class="chart-container"></div>
    </section>

    <!-- Right: Top categories -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Top 10 Product Categories</div>
          <div class="card-sub">By total revenue</div>
        </div>
      </div>
      <div id="chart_top_categories" class="chart-container"></div>
    </section>
  </main>

  <div class="footer">
    Project: <code>durable-ripsaw-477914-g0</code> &nbsp;¬∑&nbsp;
    Dataset: <code>ecommerce_fact</code> + <code>ecommerce_dim</code>
  </div>
</div>

<script>
  // üîß 1) EDIT THIS: your OAuth 2.0 Client ID from Google Cloud
  const CLIENT_ID = "297911594147-9dbblho1k834h239f7g7tfhqtr6c1gvf.apps.googleusercontent.com";

  // BigQuery project & datasets
  const PROJECT_ID = "durable-ripsaw-477914-g0";

  // Scopes needed for BigQuery
  const SCOPES = "https://www.googleapis.com/auth/bigquery.readonly";

  const statusEl = document.getElementById("status");
  const signinBtn = document.getElementById("signin-btn");
  const refreshBtn = document.getElementById("refresh-btn");

  function setStatus(text) {
    statusEl.innerHTML = "Status: <span>" + text + "</span>";
  }

  // Load gapi and init auth client
  function initClient() {
    gapi.load("client:auth2", () => {
      gapi.client
        .init({
          clientId: CLIENT_ID,
          scope: SCOPES,
          discoveryDocs: ["https://bigquery.googleapis.com/$discovery/rest?version=v2"],
        })
        .then(() => {
          const auth = gapi.auth2.getAuthInstance();
          auth.isSignedIn.listen(updateSigninStatus);
          updateSigninStatus(auth.isSignedIn.get());

          signinBtn.onclick = () => {
            auth.signIn();
          };

          refreshBtn.onclick = () => {
            loadAllCharts();
          };
        })
        .catch((err) => {
          console.error("Error initializing gapi client", err);
          setStatus("Error initializing Google API ‚Äì see console");
        });
    });
  }

  function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
      setStatus("Signed in ‚Äì loading charts...");
      signinBtn.textContent = "Sign out";
      signinBtn.onclick = () => gapi.auth2.getAuthInstance().signOut();
      refreshBtn.disabled = false;
      loadAllCharts();
    } else {
      setStatus("Not signed in");
      signinBtn.textContent = "Sign in with Google";
      refreshBtn.disabled = true;
    }
  }

  // Generic BigQuery query helper
  async function runBigQuery(sql) {
    const request = {
      path: "/bigquery/v2/projects/" + PROJECT_ID + "/queries",
      method: "POST",
      body: {
        query: sql,
        useLegacySql: false,
      },
    };

    const response = await gapi.client.request(request);
    const res = response.result;

    if (!res.schema || !res.rows) {
      return [];
    }

    const fields = res.schema.fields;
    return res.rows.map((row) => {
      const obj = {};
      row.f.forEach((cell, idx) => {
        obj[fields[idx].name] = cell.v;
      });
      return obj;
    });
  }

  // Chart 1: Revenue over time
  async function drawRevenueOverTime() {
    const sql = `
      SELECT
        order_date_key AS order_date,
        SUM(gross_order_item_value) AS daily_revenue
      FROM \`durable-ripsaw-477914-g0.ecommerce_fact.fact_db_order_items\`
      GROUP BY order_date
      ORDER BY order_date
    `;

    try {
      const rows = await runBigQuery(sql);
      const dates = rows.map(r => r.order_date);
      const revenue = rows.map(r => Number(r.daily_revenue));

      const trace = {
        x: dates,
        y: revenue,
        mode: "lines",
        type: "scatter",
        hovertemplate: "%{x}<br>Revenue: %{y:.2f}<extra></extra>",
      };

      const layout = {
        margin: { l: 40, r: 20, t: 20, b: 40 },
        xaxis: { title: "Order date" },
        yaxis: { title: "Revenue (BRL)" },
      };

      Plotly.newPlot("chart_revenue_time", [trace], layout, { responsive: true });
    } catch (err) {
      console.error("Error drawing revenue chart", err);
      document.getElementById("chart_revenue_time").innerText =
        "Error loading revenue data ‚Äì check console.";
    }
  }

  // Chart 2: Top 10 categories by revenue
  async function drawTopCategories() {
    const sql = `
      SELECT
        p.product_category_name_english AS category,
        SUM(f.gross_order_item_value) AS revenue
      FROM \`durable-ripsaw-477914-g0.ecommerce_fact.fact_db_order_items\` f
      LEFT JOIN \`durable-ripsaw-477914-g0.ecommerce_dim.dim_db_products\` p
      ON f.product_id = p.product_id
      GROUP BY category
      ORDER BY revenue DESC
      LIMIT 10
    `;

    try {
      const rows = await runBigQuery(sql);
      const categories = rows.map(r => r.category || "Unknown");
      const revenue = rows.map(r => Number(r.revenue));

      const trace = {
        x: revenue,
        y: categories,
        type: "bar",
        orientation: "h",
        hovertemplate: "%{y}<br>Revenue: %{x:.2f}<extra></extra>",
      };

      const layout = {
        margin: { l: 120, r: 20, t: 20, b: 40 },
        xaxis: { title: "Revenue (BRL)" },
        yaxis: { automargin: true },
      };

      Plotly.newPlot("chart_top_categories", [trace], layout, { responsive: true });
    } catch (err) {
      console.error("Error drawing categories chart", err);
      document.getElementById("chart_top_categories").innerText =
        "Error loading category data ‚Äì check console.";
    }
  }

  async function loadAllCharts() {
    setStatus("Signed in ‚Äì running BigQuery queries...");
    await Promise.all([drawRevenueOverTime(), drawTopCategories()]);
    setStatus("Charts loaded from BigQuery");
  }

  // Kick off gapi on load
  window.onload = () => {
    setStatus("Loading Google API client...");
    initClient();
  };
</script>
</body>
</html>
